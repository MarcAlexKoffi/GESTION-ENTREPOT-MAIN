<div class="page-container">
    
        <!-- HEADER -->
        <header class="page-header">
            <div class="header-left">
                <h1 class="page-title">{{ entrepot.nom }}</h1>
                <p class="page-subtitle">{{ entrepot.lieu }}</p>
            </div>
            <button type="button" class="btn btn-primary" (click)="openModal()">
                <span class="material-symbols-outlined">add</span>
                <span>Enregistrer un camion</span>
            </button>
        </header>

        <!-- CONTROLS ROW -->
        <section class="controls-area">
            <div class="search-and-filters">
                <!-- SEARCH -->
                <div class="search-box">
                    <span class="material-symbols-outlined search-icon">search</span>
                    <input type="text" placeholder="Rechercher un camion..." [(ngModel)]="filterSearch"
                        (ngModelChange)="applyFilters()" />
                </div>

                <!-- PERIOD FILTER -->
                <div class="filter-dropdown-wrapper">
                    <div class="filter-chip-wrap" (click)="togglePeriodMenu()">
                        <span class="material-symbols-outlined">calendar_today</span>
                        <span class="chip-label">{{ periodLabel }}</span>
                        <span class="material-symbols-outlined">arrow_drop_down</span>
                    </div>

                     <div class="filter-dropdown" *ngIf="showPeriodMenu">
                        <button type="button" class="dropdown-item" (click)="setPeriod('today')">Aujourd'hui</button>
                        <button type="button" class="dropdown-item" (click)="setPeriod('week')">Cette semaine</button>
                        <button type="button" class="dropdown-item" (click)="setPeriod('month')">Ce mois</button>
                        <button type="button" class="dropdown-item" (click)="setPeriod('year')">Cette année</button>
                    </div>
                </div>

                 <!-- DATE INPUT -->
                 <input type="date" class="date-input" [(ngModel)]="filterDate" (ngModelChange)="onDateChange()" />
            </div>
        </section>

        <!-- MAIN CARD -->
        <div class="card table-card">
            <!-- TABS HEADER -->
             <div class="card-tabs-header">
                <button class="tab-btn" 
                    [class.active]="currentTab === 'enregistres'"
                    (click)="currentTab = 'enregistres'; applyFilters()">
                    Enregistrés
                    <!-- <span class="tab-badge">{{ nbEnregistresByPeriod }}</span> -->
                </button>

                 <button class="tab-btn" 
                    [class.active]="currentTab === 'attente'"
                    (click)="currentTab = 'attente'; applyFilters()">
                    En attente
                    <span class="tab-badge" *ngIf="nbAttenteByPeriod > 0">{{ nbAttenteByPeriod }}</span>
                </button>

                <button class="tab-btn" 
                    [class.active]="currentTab === 'valides'"
                    (click)="currentTab = 'valides'; applyFilters()">
                    Validés
                    <span class="tab-badge" *ngIf="nbValidesByPeriod > 0">{{ nbValidesByPeriod }}</span>
                </button>

                 <button class="tab-btn" 
                    [class.active]="currentTab === 'refoules'"
                    (click)="currentTab = 'refoules'; applyFilters()">
                    Refoulés
                    <span class="tab-badge" *ngIf="nbRefoulesByPeriod > 0">{{ nbRefoulesByPeriod }}</span>
                </button>

                <button class="tab-btn" 
                    [class.active]="currentTab === 'acceptes'"
                    (click)="currentTab = 'acceptes'; applyFilters()">
                    Acceptés
                <span class="tab-badge" *ngIf="nbAcceptesByPeriod > 0">{{ nbAcceptesByPeriod }}</span>
                </button>
                 <button class="tab-btn" 
                    [class.active]="currentTab === 'historique'"
                    (click)="currentTab = 'historique'; applyFilters()">
                    Historique
                    <!-- <span class="tab-badge">{{ historique.length }}</span> -->
                </button>
            </div>

            <!-- TABLE -->
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th>Immatriculation</th>
                            <th>Transporteur</th>
                            <th>Heure</th>
                            <th>Statut</th>
                            <th>Statut avancé</th>
                            <th style="text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngIf="filteredTrucks.length === 0">
                            <td colspan="6" style="padding: 0;">
                                <div class="empty-state-content">
                                    <span class="material-symbols-outlined">info</span>
                                    <p>Aucun camion trouvé pour ce statut.</p>
                                </div>
                            </td>
                        </tr>
                        <tr *ngFor="let t of filteredTrucks" class="row-hover">
                            <!-- IMMATRICULATION -->
                             <td>
                                <div style="display:flex; align-items:center; gap:0.5rem; font-weight:700;">
                                    {{ t.immatriculation }}
                                    <span *ngIf="t.unreadForGerant" class="badge-new">Nouveau</span>
                                </div>
                             </td>
                             <!-- TRANSPORTEUR -->
                             <td class="cell-muted">{{ t.transporteur }}</td>
                             <!-- HEURE -->
                             <td class="cell-muted">{{ getHourForCurrentTab(t) }}</td>
                             <!-- STATUT -->
                             <td>
                                <span *ngIf="t.statut === 'Enregistré'" class="status-pill status-pill--enregistre">
                                    <span class="material-symbols-outlined" style="font-size:16px">save_as</span> Enregistré
                                </span>
                                <span *ngIf="t.statut === 'En attente'" class="status-pill status-pill--pending">
                                    <span class="material-symbols-outlined" style="font-size:16px">hourglass_empty</span> En attente
                                </span>
                                <span *ngIf="t.statut === 'Validé'" class="status-pill status-pill--validated">
                                    <span class="material-symbols-outlined" style="font-size:16px">check_circle</span> Validé
                                </span>
                                <span *ngIf="t.statut === 'Refoulé' || (t.statut === 'Annulé' && (t.advancedStatus === 'REFUSE_EN_ATTENTE_GERANT' || t.advancedStatus === 'REFUSE_RENVOYE'))" class="status-pill status-pill--refoule">
                                    <span class="material-symbols-outlined" style="font-size:16px">cancel</span> Refoulé
                                </span>
                                <span *ngIf="t.statut === 'Annulé' && !t.advancedStatus" class="status-pill status-pill--refoule">
                                    <span class="material-symbols-outlined" style="font-size:16px">cancel</span> Annulé
                                </span>
                             </td>
                             <!-- STATUT AVANCÉ -->
                             <td>
                                <ng-container [ngSwitch]="t.advancedStatus">
                                    <span *ngSwitchCase="'REFUSE_EN_ATTENTE_GERANT'" class="status-pill status-pill--pending">
                                        <span class="material-symbols-outlined" style="font-size:16px">pending</span> En attente gérant
                                    </span>
                                    <span *ngSwitchCase="'REFUSE_RENVOYE'" class="status-pill status-pill--renvoye">
                                         <span class="material-symbols-outlined" style="font-size:16px">reply</span> Renvoyé
                                    </span>
                                    <span *ngSwitchCase="'ACCEPTE_FINAL'" class="status-pill status-pill--accepted-final">
                                         <span class="material-symbols-outlined" style="font-size:16px">assignment_turned_in</span> Accepté déf.
                                    </span>
                                    <span *ngSwitchDefault class="cell-muted"> — </span>
                                </ng-container>
                             </td>
                             <!-- ACTIONS -->
                             <td>
                                <div class="actions-group">
                                    <!-- ENREGISTRÉ -->
                                    <ng-container *ngIf="t.statut === 'Enregistré'">
                                        <button class="action-btn btn-edit" title="Modifier" (click)="openEditModal(t)">
                                            <span class="material-symbols-outlined">edit</span>
                                        </button>
                                        <button class="action-btn btn-science" title="Analyses" (click)="openAnalysisModal(t)">
                                            <span class="material-symbols-outlined">science</span>
                                        </button>
                                    </ng-container>
                                    
                                    <!-- VALIDÉ -->
                                    <button class="action-btn btn-inventory" title="Produits" 
                                        *ngIf="t.statut === 'Validé' && t.advancedStatus !== 'ACCEPTE_FINAL'"
                                        (click)="openProductsModal(t)">
                                        <span class="material-symbols-outlined">inventory_2</span>
                                    </button>

                                    <!-- REFOULE -->
                                    <button class="action-btn btn-send" title="Marquer renvoyé"
                                        *ngIf="(t.statut === 'Refoulé' || t.statut === 'Annulé') && t.advancedStatus === 'REFUSE_EN_ATTENTE_GERANT'"
                                        (click)="markAsRenvoye(t)">
                                        <span class="material-symbols-outlined">send</span>
                                    </button>

                                    <!-- HISTORIQUE -->
                                    <button class="action-btn btn-history" title="Historique" (click)="openHistoryModal(t)">
                                        <span class="material-symbols-outlined">history</span>
                                    </button>

                                    <!-- DETAILS VIEW -->
                                     <button class="action-btn btn-history" title="Détails" (click)="openDetails(t)" 
                                        *ngIf="t.advancedStatus === 'ACCEPTE_FINAL' && t.products">
                                        <span class="material-symbols-outlined">visibility</span>
                                     </button>
                                </div>
                             </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

<!-- ================= MODALES ================= -->

 <!-- MODALE ENREGISTREMENT CAMION -->
  <div class="modal-root" *ngIf="showModal">
    <div class="modal-backdrop" (click)="closeModal()"></div>
    <div class="modal-panel">
      
      <div class="modal-header">
        <h2 class="modal-title">Enregistrer un nouveau camion</h2>
        <button type="button" class="btn-close-icon" aria-label="Fermer" (click)="closeModal()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Entrepôt -->
        <div class="truck-field">
          <label class="truck-label" for="entrepot">Entrepôt</label>
          <select id="entrepot" class="truck-select" disabled>
            <option selected>{{ entrepot.nom }}</option>
          </select>
        </div>

        <!-- Immatriculation -->
        <div class="truck-field">
          <label class="truck-label" for="immatriculation"> Immatriculation du camion </label>
          <input
            id="immatriculation"
            type="text"
            class="truck-input"
            placeholder="Ex : AB-123-CD"
            [(ngModel)]="newTruck.immatriculation"
            name="immatriculation"
            required
          />
        </div>

        <!-- Transporteur -->
        <div class="truck-field">
          <label class="truck-label" for="transporteur"> Transporteur / Chauffeur </label>
          <input
            id="transporteur"
            type="text"
            class="truck-input"
            placeholder="Nom du transporteur ou du chauffeur"
            [(ngModel)]="newTruck.transporteur"
            name="transporteur"
            required
          />
        </div>

        <!-- N° fiche de transfert -->
        <div class="truck-field">
          <label class="truck-label" for="transfert"> N° fiche de transfert </label>
          <input
            id="transfert"
            type="text"
            class="truck-input"
            placeholder="Ex : FT-2025-001"
            [(ngModel)]="newTruck.transfert"
            name="transfert"
          />
        </div>

        <!-- Coopérative -->
        <div class="truck-field">
          <label class="truck-label" for="cooperative"> Nom coopérative </label>
          <input
            id="cooperative"
            type="text"
            class="truck-input"
            placeholder="Ex : AMIAN"
            [(ngModel)]="newTruck.cooperative"
            name="cooperative"
          />
        </div>

        <!-- Confirmation / Footer area inside body for this specific layout or strictly footer? 
             The original had them inside body/flow. Let's move button to a real footer if we want rigorous design, 
             but looking at the original code, the 'truck-modal-footer' was just a div at the bottom.
             I'll use a semantic modal-footer.
        -->
      </div>

      <div class="modal-footer" style="display:block">
          <div class="truck-confirm" *ngIf="showSuccessBanner" style="margin-bottom: 1rem; padding: 1rem; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; color: #166534;">
            <span class="material-symbols-outlined">check_circle</span>
            <div>
              <p style="margin:0; font-weight:700">Camion enregistré</p>
              <p style="margin:0; font-size:0.875rem">Statut : {{ lastSavedStatutLabel }}</p>
            </div>
          </div>

          <button type="button" class="truck-submit" (click)="saveTruck()">
            Enregistrer l’arrivée
          </button>
      </div>

    </div>
  </div>

<!-- EDIT MODAL -->
<div class="modal-root" *ngIf="showEditModal">
    <div class="modal-backdrop" (click)="closeEditModal()"></div>
    <div class="modal-panel">
        <div class="modal-header">
            <h2 class="modal-title">Modifier le camion</h2>
            <button class="btn-close-icon" (click)="closeEditModal()">
                <span class="material-symbols-outlined" style="font-size:20px">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="truck-field">
                <label class="truck-label">Immatriculation</label>
                <input class="truck-input" [(ngModel)]="editTruckData.immatriculation">
            </div>
            <div class="truck-field">
                <label class="truck-label">Transporteur</label>
                <input class="truck-input" [(ngModel)]="editTruckData.transporteur">
            </div>
             <div class="truck-field">
                <label class="truck-label">Transfert</label>
                <input class="truck-input" [(ngModel)]="editTruckData.transfert">
            </div>
             <div class="truck-field">
                <label class="truck-label">Coopérative</label>
                <input class="truck-input" [(ngModel)]="editTruckData.cooperative">
            </div>
        </div>
        <div class="modal-footer">
            <button class="truck-submit" (click)="submitEditTruck()">Mettre à jour</button>
        </div>
    </div>
</div>

<!-- ANALYSIS MODAL -->
<div class="modal-root" *ngIf="showAnalysisModal">
    <div class="modal-backdrop" (click)="closeAnalysisModal()"></div>
    <div class="modal-panel">
        <div class="modal-header">
            <h2 class="modal-title">Résultats d'analyse</h2>
            <button class="btn-close-icon" (click)="closeAnalysisModal()">
                <span class="material-symbols-outlined" style="font-size:20px">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div style="margin-bottom:1rem; padding:1rem; background:#f0f9ff; border-radius:0.75rem; color:#0369a1; font-size:0.9rem;">
                Veuillez saisir les résultats de l'analyse (TH, Impuretés, Grainage, etc.) pour envoyer le camion en validation Admin.
            </div>

            <div class="truck-field">
                <label class="truck-label">Taux d'Humidité (TH)</label>
                <input type="number" class="truck-input" [(ngModel)]="analysisData.th" placeholder="Ex: 12.5">
            </div>
             <div class="truck-field">
                <label class="truck-label">Impuretés</label>
                <input type="number" class="truck-input" [(ngModel)]="analysisData.impurete" placeholder="Ex: 2.1">
            </div>
             <div class="truck-field">
                <label class="truck-label">Grainage</label>
                <input type="number" class="truck-input" [(ngModel)]="analysisData.grainage" placeholder="Ex: 180">
            </div> 
            <div class="truck-field">
                <label class="truck-label">Taux de défectuosité</label>
                <input type="number" class="truck-input" [(ngModel)]="analysisData.defaut" placeholder="Ex: 1.5">
            </div>

            <div *ngIf="isAnalysisInvalid" style="color:#ef4444; font-weight:700; margin-top:1rem;">
                Tous les champs numériques sont requis.
            </div>
        </div>
        <div class="modal-footer">
            <button class="truck-submit" (click)="submitAnalysis()" [disabled]="loadingAnalysis">
                {{ loadingAnalysis ? 'Envoi...' : 'Soumettre à l\'Admin' }}
            </button>
        </div>
    </div>
</div>

<!-- PRODUCTS MODAL -->
<div class="modal-root" *ngIf="showProductsModal">
    <div class="modal-backdrop" (click)="closeProductsModal()"></div>
     <div class="modal-panel">
        <div class="modal-header">
            <h2 class="modal-title">Détails produits</h2>
            <button class="btn-close-icon" (click)="closeProductsModal()">
                <span class="material-symbols-outlined" style="font-size:20px">close</span>
            </button>
        </div>
        <div class="modal-body">
             <div class="truck-field">
                <label class="truck-label">Poids (Kg)</label>
                <input type="number" class="truck-input" [(ngModel)]="productsData.poids">
            </div>
             <div class="truck-field">
                <label class="truck-label">Nombre de sacs</label>
                <input type="number" class="truck-input" [(ngModel)]="productsData.sacs">
            </div>
             <div class="truck-field">
                <label class="truck-label">Type de produit</label>
                <select class="truck-select" [(ngModel)]="productsData.type">
                    <option value="Cacao">Cacao</option>
                    <option value="Café">Café</option>
                    <option value="Anacarde">Anacarde</option>
                </select>
            </div>
            <div class="truck-field">
                <label class="truck-label">Commentaire (Facultatif)</label>
                <textarea class="truck-input" [(ngModel)]="productsData.comment" style="height:80px; resize:none;"></textarea>
            </div>
        </div>
        <div class="modal-footer">
             <button class="truck-submit" (click)="submitProducts()">Finaliser l'entrée</button>
        </div>
     </div>
</div>


<!-- HISTORY MODAL -->
<div class="modal-root" *ngIf="showHistoryModal">
    <div class="modal-backdrop" (click)="closeHistoryModal()"></div>
     <div class="modal-panel">
        <div class="modal-header">
            <h2 class="modal-title">Historique</h2>
            <button class="btn-close-icon" (click)="closeHistoryModal()">
                <span class="material-symbols-outlined" style="font-size:20px">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div *ngIf="!selectedTruckForHistory?.history?.length" class="cell-muted" style="text-align:center;">
                Aucun historique disponible.
            </div>
            <div *ngFor="let h of selectedTruckForHistory?.history" style="padding:1rem; border-bottom:1px solid #f1f5f9;">
                <div style="font-weight:700; color:#0f172a;">{{ h.action }}</div>
                <div style="font-size:0.85rem; color:#64748b;">{{ h.date | date:'dd/MM/yyyy HH:mm' }} par {{ h.user }}</div>
                <div *ngIf="h.details" style="margin-top:0.25rem; font-size:0.9rem; color:#334155;">{{ h.details }}</div>
            </div>
        </div>
    </div>
</div>

<!-- DETAILS MODAL -->
<div class="modal-root" *ngIf="showDetailsModal">
    <div class="modal-backdrop" (click)="closeDetailsModal()"></div>
     <div class="modal-panel">
        <div class="modal-header">
            <h2 class="modal-title">Détails Entrée</h2>
            <button class="btn-close-icon" (click)="closeDetailsModal()">
                <span class="material-symbols-outlined" style="font-size:20px">close</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="truck-field">
                <label class="truck-label">Produit</label>
                <div style="font-weight:600">{{ selectedTruckForDetails?.products?.type }}</div>
            </div>
            <div class="truck-field">
                <label class="truck-label">Poids</label>
                <div style="font-weight:600">{{ selectedTruckForDetails?.products?.poidsBrut }} Kg</div>
            </div>
            <div class="truck-field">
                <label class="truck-label">Sacs</label>
                <div style="font-weight:600">{{ selectedTruckForDetails?.products?.nombreSacsDecharges }}</div>
            </div>
        </div>
    </div>
</div>