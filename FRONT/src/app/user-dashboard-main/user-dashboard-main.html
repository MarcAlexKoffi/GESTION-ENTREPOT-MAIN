<div class="dashboard-wrapper">
  <!-- HEADER -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-titles">
        <h1>Tableau de bord — {{ entrepotName }}</h1>
        <p class="subtitle">
           Bienvenue{{ currentUser?.nom ? ', ' + currentUser?.nom : '' }}.
           <span *ngIf="trucks.length > 0">{{ trucks.length }} camions total enregistrés.</span>
        </p>
      </div>
      
      <div class="header-actions">
        <!-- Période Tabs -->
        <div class="period-selector">
          <button 
            [class.active]="period === 'today'" 
            (click)="period='today'; onPeriodChange()"
          >Aujourd'hui</button>
          <button 
            [class.active]="period === 'week'" 
            (click)="period='week'; onPeriodChange()"
          >Semaine</button>
          <button 
            [class.active]="period === 'month'" 
            (click)="period='month'; onPeriodChange()"
          >Mois</button>
          <button 
            [class.active]="period === 'year'" 
            (click)="period='year'; onPeriodChange()"
          >Année</button>
        </div>
        
        <!-- Date Picker -->
         <div class="date-input-wrapper">
          <span class="material-symbols-outlined notranslate input-icon">calendar_today</span>
          <input 
            type="date" 
            [(ngModel)]="filterDate" 
            (ngModelChange)="onDateChange()"
            placeholder="Date spécifique"
          >
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN KPI SUMMARY Section -->
  <section class="kpi-summary">
    <!-- Total Présents -->
    <div class="summary-card primary">
      <div class="card-icon">
        <span class="material-symbols-outlined notranslate">local_shipping</span>
      </div>
      <div class="card-data">
        <span class="card-label">Total Présents</span>
        <span class="card-value">{{ totalPresents }}</span>
      </div>
    </div>

    <!-- En cours global (En attente + Validés en attente + Attente Décision) -->
    <div class="summary-card info">
      <div class="card-icon">
        <span class="material-symbols-outlined notranslate">hourglass_top</span>
      </div>
      <div class="card-data">
        <span class="card-label">En Traitement</span>
        <span class="card-value">{{ enAttente + enDechargement + attenteDecisionAdmin }}</span>
      </div>
    </div>

    <!-- Terminé (Accepté) -->
    <div class="summary-card success">
      <div class="card-icon">
        <span class="material-symbols-outlined notranslate">check_circle</span>
      </div>
      <div class="card-data">
        <span class="card-label">Acceptés / Déchargés</span>
        <span class="card-value">{{ decharges }}</span>
      </div>
    </div>
  </section>

  <!-- DETAILED STATS GRID -->
  <section class="details-section">
    <h2 class="section-title">Détails des statuts</h2>
    <div class="details-grid">
      
      <div class="detail-card">
        <div class="detail-header">
            <span class="dot info"></span>
            <span class="title">En attente</span>
        </div>
        <div class="detail-value">{{ enAttente }}</div>
      </div>

       <div class="detail-card">
        <div class="detail-header">
            <span class="dot warning"></span>
            <span class="title">Validés (Attente)</span>
        </div>
        <div class="detail-value">{{ enDechargement }}</div>
      </div>

       <div class="detail-card">
        <div class="detail-header">
            <span class="dot orange"></span>
            <span class="title">Décision Admin</span>
        </div>
        <div class="detail-value">{{ attenteDecisionAdmin }}</div>
      </div>

       <div class="detail-card">
        <div class="detail-header">
            <span class="dot danger"></span>
            <span class="title">Refusés (Gérant)</span>
        </div>
        <div class="detail-value">{{ refusesAttenteGerant }}</div>
      </div>

       <div class="detail-card">
        <div class="detail-header">
            <span class="dot purple"></span>
            <span class="title">Refusés (Renvoyés)</span>
        </div>
        <div class="detail-value">{{ refusesRenvoyes }}</div>
      </div>

      <div class="detail-card">
        <div class="detail-header">
            <span class="dot teal"></span>
            <span class="title">Réintégrés</span>
        </div>
        <div class="detail-value">{{ refusesRintegres }}</div>
      </div>

    </div>
  </section>

  <!-- RECENT ACTIVITY TABLE -->
  <section class="activity-section">
    <div class="section-header">
        <h2 class="section-title">Activité Récente</h2>
    </div>
    
    <div class="table-container">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Immatriculation</th>
            <th>Transporteur</th>
            <th>Fiche de transport</th>
            <th>Statut</th>
            <th>Date / Heure</th>
            <th class="text-right">Poids (Net)</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let truck of filteredTrucks | slice:0:10">
            <td class="fw-bold">{{ truck.immatriculation }}</td>
            <td>{{ truck.transporteur || '-' }}</td>
            <td>
                <span class="text-primary fw-medium">{{ truck.transfert || '-' }}</span>
            </td>
            <td>
              <span class="status-pill" [ngClass]="{
                'status-success': truck.statut === 'Déchargé' || truck.statut === 'Validé',
                'status-warning': truck.statut === 'En attente' || truck.statut === 'En cours de déchargement',
                'status-danger': truck.statut === 'Annulé' || truck.statut === 'Refoulé',
                'status-registered': truck.statut === 'Enregistré'
              }">
                <span class="material-symbols-outlined notranslate">
                    {{ 
                        truck.statut === 'Déchargé' || truck.statut === 'Validé' ? 'check_circle' :
                        truck.statut === 'Annulé' || truck.statut === 'Refoulé' ? 'cancel' :
                        truck.statut === 'En cours de déchargement' ? 'pending' :
                        truck.statut === 'Enregistré' ? 'app_registration' :
                        'hourglass_empty'
                    }}
                </span>
                {{ truck.statut }}
              </span>
            </td>
            <td>{{ (truck.heureArrivee | date:'dd/MM/yy HH:mm') || '-' }}</td>
            <td class="text-right monospace">{{ truck.products?.poidsNet ? (truck.products?.poidsNet + ' kg') : '-' }}</td>
          </tr>
          <tr *ngIf="filteredTrucks.length === 0">
            <td colspan="6" class="empty-cell">
               <div class="empty-state">
                   <span class="material-symbols-outlined notranslate">inbox</span>
                   <p>Aucune donnée pour la période sélectionnée.</p>
               </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

</div>
