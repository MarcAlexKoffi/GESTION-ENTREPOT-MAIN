<div class="pageMain">
  <div class="admin-root">
    <main class="admin-main">
      <div class="admin-scroll">
        <div class="content">
          <div class="page-head">
            <div>
              <h2 class="page-title">Utilisateurs</h2>
              <p class="page-desc">Gérez les accès et affectez les entrepôts aux opérateurs.</p>
            </div>
            <button class="btn-primary" type="button" (click)="openCreateUser()">
              <span class="material-symbols-outlined notranslate">person_add</span>
              <span>Créer un utilisateur</span>
            </button>
          </div>
          <!-- Toast Message (Simple & Sleek) -->


          <!-- Filters Section -->
          <section class="card filters" aria-label="Filtres">
            <div class="filters-row">
              <div class="field">
                <span class="left-icon">
                  <span class="material-symbols-outlined notranslate">search</span>
                </span>
                <input
                  type="text"
                  placeholder="Rechercher par nom ou identifiant..."
                  [(ngModel)]="searchTerm"
                />
              </div>

              <div class="select-wrap">
                <select aria-label="Filtrer par rôle" [(ngModel)]="selectedRole">
                  <option value="">Tous les rôles</option>
                  <option value="admin">Administrateur</option>
                  <option value="operator">Opérateur</option>
                </select>
              </div>

              <div class="select-wrap">
                <select aria-label="Filtrer par entrepôt" [(ngModel)]="selectedWarehouseId">
                  <option value="">Tous les entrepôts</option>
                  <option *ngFor="let w of warehouses" [value]="w.id">{{ w.name }}</option>
                </select>
              </div>
            </div>
          </section>

          <!-- Users Table -->
          <section class="card" aria-label="Liste des utilisateurs">
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Utilisateur</th>
                    <th>Rôle</th>
                    <th class="hide-md">Entrepôt Affecté</th>
                    <th>Statut</th>
                    <th style="text-align: right">Actions</th>
                  </tr>
                </thead>

                <tbody>
                  <tr *ngIf="filteredUsers.length === 0">
                    <td colspan="5" class="sub" style="text-align: center; padding: 3rem">
                      <span
                        class="material-symbols-outlined notranslate"
                        style="font-size: 3rem; opacity: 0.1; display: block; margin-bottom: 1rem"
                        >person_off</span
                      >
                      Aucun utilisateur ne correspond aux filtres.
                    </td>
                  </tr>

                  <tr *ngFor="let u of filteredUsers">
                    <td>
                      <div class="user-cell">
                        <div class="initials">{{ getInitials(u.nom) }}</div>
                        <div>
                          <span class="name">{{ u.nom }}</span>
                          <span class="sub">@{{ u.username }}</span>
                        </div>
                      </div>
                    </td>

                    <td>
                      <span class="badge">
                        <span class="material-symbols-outlined notranslate">{{ roleIcon(u.role) }}</span>
                        {{ roleLabel(u.role) }}
                      </span>
                    </td>

                    <td class="hide-md">
                      <div class="warehouse-display" *ngIf="u.role === 'operator'">
                        <span
                          class="material-symbols-outlined notranslate"
                          style="font-size: 18px; color: var(--text-secondary); opacity: 0.7"
                          >domain</span
                        >
                        <span
                          [style.color]="
                            u.entrepotId ? 'var(--text-primary)' : 'var(--text-secondary)'
                          "
                        >
                          {{ getWarehouseName(u.entrepotId) }}
                        </span>
                      </div>
                      <span
                        class="sub"
                        *ngIf="u.role === 'admin'"
                        style="font-style: italic; opacity: 0.6"
                      >
                        Accès complet
                      </span>
                    </td>

                    <td>
                      <span
                        class="status-pill"
                        [ngClass]="{
                          'status-pill--validated': u.status === 'Actif',
                          'status-pill--refoule': u.status === 'Inactif',
                          'status-pill--pending': u.status === 'En attente'
                        }"
                      >
                        <span class="dot"></span>
                        {{ u.status }}
                      </span>
                    </td>

                    <td>
                      <div class="row-actions">
                        <button
                          class="mini-btn"
                          title="Modifier"
                          type="button"
                          (click)="openEditUser(u)"
                        >
                          <span class="material-symbols-outlined notranslate">edit</span>
                        </button>

                        <button
                          class="mini-btn danger"
                          title="Supprimer"
                          type="button"
                          (click)="deleteUser(u)"
                        >
                          <span class="material-symbols-outlined notranslate">delete</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- MODAL: Create/Edit User -->
          <div class="modal" *ngIf="showUserModal">
            <div class="modal__backdrop" (click)="closeUserModal()"></div>

            <div class="modal__panel">
              <div class="truck-modal-header">
                <h2 class="truck-modal-title">
                  {{ isEditMode ? 'Modifier l’utilisateur' : 'Créer un utilisateur' }}
                </h2>
                <button
                  type="button"
                  class="truck-modal-close"
                  aria-label="Fermer"
                  (click)="closeUserModal()"
                >
                  <span class="material-symbols-outlined notranslate">close</span>
                </button>
              </div>

              <div class="truck-modal-body">
                <div class="truck-field">
                  <label class="truck-label">Nom <span style="color:red">*</span></label>
                   <input
                     class="truck-input"
                     type="text"
                     placeholder="Ex : Paule Yves"
                     [(ngModel)]="formUser.nom"
                     required
                   />
                   <div class="field-error" *ngIf="saveAttempted && !formUser.nom">
                     Le nom est requis.
                   </div>
                </div>

                <div class="truck-field">
                  <label class="truck-label">Identifiant (Username) <span style="color:red">*</span></label>
                   <input
                     class="truck-input"
                     type="text"
                     placeholder="Ex : pyves"
                     [(ngModel)]="formUser.username"
                     required
                   />
                   <div class="field-error" *ngIf="saveAttempted && !formUser.username">
                     L'identifiant est requis.
                   </div>
                </div>

                <div class="truck-field">
                  <label class="truck-label">
                    Mot de passe
                    <small *ngIf="isEditMode" style="text-transform: none; opacity: 0.7">
                      (laisser vide pour ne pas changer)</small
                    >
                  </label>
                  <div class="password-wrapper" style="position: relative;">
                    <input
                      class="truck-input"
                      [type]="showPassword ? 'text' : 'password'"
                      placeholder="**********"
                      [(ngModel)]="formUser.password"
                      name="password"
                      style="padding-right: 2.5rem;"
                    />
                    <button 
                      type="button" 
                      (click)="showPassword = !showPassword"
                      style="
                        position: absolute;
                        right: 0.75rem;
                        top: 50%;
                        transform: translateY(-50%);
                        background: none;
                        border: none;
                        color: #94a3b8;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                      "
                    >
                      <span class="material-symbols-outlined notranslate" style="font-size: 20px;">
                        {{ showPassword ? 'visibility_off' : 'visibility' }}
                      </span>
                    </button>
                  </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem">
                  <div class="truck-field">
                    <label class="truck-label">Rôle <span style="color:red">*</span></label>
                    <select class="truck-select" [(ngModel)]="formUser.role" required>
                      <option value="admin">Administrateur</option>
                      <option value="operator">Opérateur</option>
                    </select>
                  </div>

                  <div class="truck-field">
                    <label class="truck-label">Statut <span style="color:red">*</span></label>
                    <select class="truck-select" [(ngModel)]="formUser.status" required>
                      <option value="Actif">Actif</option>
                      <option value="Inactif">Inactif</option>
                      <!-- <option value="En attente">En attente</option> -->
                    </select>
                  </div>
                </div>

                <div class="truck-field" *ngIf="formUser.role === 'operator'">
                  <label class="truck-label">Entrepôt Affecté <span style="color:red">*</span></label>
                  <select
                    class="truck-select"
                    [(ngModel)]="formUser.entrepotId"
                    [disabled]="warehouses.length === 0"
                    required
                  >
                    <option [ngValue]="null">Sélectionner un entrepôt</option>
                    <option *ngFor="let w of warehouses" [ngValue]="w.id">{{ w.name }}</option>
                  </select>
                  <p
                    class="truck-help"
                    *ngIf="warehouses.length === 0"
                    style="color: #ef4444; font-size: 0.75rem; margin-top: 0.25rem"
                  >
                    Aucun entrepôt disponible.
                  </p>
                </div>
              </div>

              <div class="truck-modal-footer">
                <button type="button" class="btn-secondary" (click)="closeUserModal()" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; background: transparent; font-weight: 700; color: #64748b; cursor: pointer;">
                  Annuler
                </button>
                <button type="button" class="truck-submit" (click)="saveUserFromModal()" [disabled]="isLoading">
                  <ng-container *ngIf="!isLoading">{{ isEditMode ? 'Enregistrer' : 'Créer l’utilisateur' }}</ng-container>
                  <ng-container *ngIf="isLoading">Enregistrement...</ng-container>
                </button>
              </div>
            </div>
          </div>

          <!-- MODALE : Confirmation Suppression -->
          <div class="modal" *ngIf="showDeleteModal">
            <div class="modal__backdrop" (click)="cancelDelete()"></div>
            <div class="modal__panel" style="max-width: 420px;">
              <div class="truck-modal-header">
                <h2 class="truck-modal-title">Confirmer la suppression</h2>
                <button
                  type="button"
                  class="truck-modal-close"
                  aria-label="Fermer"
                  (click)="cancelDelete()"
                >
                  <span class="material-symbols-outlined notranslate">close</span>
                </button>
              </div>

              <div class="truck-modal-body">
                 <p style="color: #64748b; line-height: 1.5; margin-bottom: 0.5rem;">
                   Êtes-vous sûr de vouloir supprimer cet utilisateur ?
                 </p>
                 <div *ngIf="userToDelete" style="background: #f8fafc; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                    <p style="margin: 0; font-weight: 700; color: #0f172a;">{{ userToDelete.nom }}</p>
                    <p style="margin: 0.25rem 0 0; font-size: 0.85rem; color: #64748b;">
                       @{{ userToDelete.username }}
                    </p>
                    <p style="margin: 0.25rem 0 0; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-weight: 600;">
                       {{ roleLabel(userToDelete.role) }}
                    </p>
                 </div>
                 <p style="color: #ef4444; font-size: 0.85rem; margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-symbols-outlined notranslate" style="font-size: 18px;">warning</span>
                    Cette action est irréversible.
                 </p>
              </div>

              <div class="truck-modal-footer">
                <button type="button" class="btn-secondary" (click)="cancelDelete()" style="padding: 0.75rem 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; background: transparent; font-weight: 700; color: #64748b; cursor: pointer;">
                  Annuler
                </button>
                <button 
                  type="button" 
                  class="btn-primary" 
                  style="background: #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border: none; padding: 0.75rem 1.5rem; border-radius: 0.75rem; font-weight: 700; color: white; cursor: pointer;"
                  (click)="confirmDelete()"
                >
                  Supprimer
                </button>
              </div>
            </div>
          </div>
          <!-- END MODAL -->
        </div>
      </div>
    </main>
  </div>
</div>
