<div class="page-container">
    <header class="page-header">
      <div>
        <h1 class="page-title">Gestion des Empotages</h1>
        <p class="page-subtitle">Suivez et gérez l'ensemble de vos opérations de chargement.</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <span class="material-symbols-outlined">add</span>
        <span>Nouveau empotage</span>
      </button>
    </header>

    <!-- CONTROLS: search, status filter, export -->
    <div class="controls-row">
      <div class="control-item search-wrapper">
        <span class="material-symbols-outlined search-icon">search</span>
        <input type="text" placeholder="Recherche client ou booking..." [(ngModel)]="search" (ngModelChange)="calculateStats()" class="search-input" />
      </div>
      
      <!-- Warehouse Selector -->
      <div class="control-item">
        <select [(ngModel)]="selectedWarehouseId" (change)="loadEmpotages()" class="status-select" style="padding: 0.75rem; color: #64748b; font-family: inherit;">
          <option [ngValue]="null" disabled>Choisir un entrepôt</option>
          <option *ngFor="let w of warehouses" [ngValue]="w.id">{{ w.name }}</option>
        </select>
      </div>

      <div class="control-item">
        <input 
          type="date" 
          [(ngModel)]="filterDate" 
          (ngModelChange)="calculateStats()"
          class="status-select" 
          style="padding: 0.75rem; color: #64748b; font-family: inherit;" 
        />
      </div>
      <div class="control-item control-actions">
        <button class="btn btn-primary" (click)="exportCsv()" [disabled]="loading">
          <span class="material-symbols-outlined">file_download</span>
          <span>Exporter CSV</span>
        </button>
      </div>
    </div>

    <!-- CREATE MODAL -->
    <div class="modal" *ngIf="showCreateModal">
      <div class="modal__backdrop" (click)="closeCreateModal()"></div>
      <div class="modal__panel">
        <div class="truck-modal-header">
          <h2 class="truck-modal-title">{{ isEditing ? 'Modifier empotage' : 'Créer un nouvel empotage' }}</h2>
          <button class="truck-modal-close" (click)="closeCreateModal()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        
        <div class="truck-modal-body">
            <div *ngIf="errorMessage" style="background-color: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
               <span class="material-symbols-outlined" style="font-size: 18px;">error</span>
               {{ errorMessage }}
            </div>

            <div class="form-row">
                <label>Client</label>
                <input type="text" [(ngModel)]="newEmpotage.client" name="client" required placeholder="Ex: Marcus Koné" />
            </div>

            <div class="form-row">
                <label>Numéro de Booking</label>
                <input type="text" [(ngModel)]="newEmpotage.booking" name="booking" required placeholder="Ex: BK-98213" />
            </div>

            <div class="form-row two-cols">
                <div>
                <label>Conteneurs</label>
                <input type="number" min="1" [(ngModel)]="newEmpotage.conteneurs" name="conteneurs" required placeholder="NB" />
                </div>
                <div>
                <label>Volume (m³)</label>
                <input type="number" step="0.1" [(ngModel)]="newEmpotage.volume" name="volume" required placeholder="m³" />
                </div>
            </div>

            <div class="form-row two-cols">
                <div>
                <label>Début</label>
                <input type="datetime-local" [(ngModel)]="newEmpotage.dateStart" name="dateStart" required />
                </div>
                <div>
                <label>Fin</label>
                <input type="datetime-local" [(ngModel)]="newEmpotage.dateEnd" name="dateEnd" required />
                </div>
            </div>
        </div>

        <div class="truck-modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()" [disabled]="saving">Annuler</button>
            <button type="button" class="btn btn-primary" (click)="saveEmpotage()" [disabled]="saving">
                <span *ngIf="!saving">{{ isEditing ? 'Enregistrer' : 'Créer' }}</span>
                <span *ngIf="saving">En cours...</span>
            </button>
        </div>
      </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal" *ngIf="showDeleteModal">
      <div class="modal__backdrop" (click)="cancelDelete()"></div>
      <div class="modal__panel">
        <div class="truck-modal-header">
          <h2 class="truck-modal-title">Confirmer la suppression</h2>
          <button class="truck-modal-close" (click)="cancelDelete()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div class="truck-modal-body">
            <div style="color: var(--text-secondary); line-height: 1.5;">
                <p>Êtes-vous sûr de vouloir supprimer cet empotage ?</p>
                <p *ngIf="itemToDelete" style="font-weight: 600; color: var(--text-primary); margin-top: 0.5rem;">
                    {{ itemToDelete.client }} ({{ itemToDelete.booking }})
                </p>
                <p style="margin-top: 0.5rem; font-size: 0.9em; color: #ef4444; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-symbols-outlined" style="font-size: 18px;">warning</span>
                    Cette action est irréversible.
                </p>
            </div>
        </div>
        <div class="truck-modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelDelete()">Annuler</button>
          <button type="button" class="btn btn-primary" style="background: #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border: none;" (click)="confirmDelete()">
            Supprimer
          </button>
        </div>
      </div>
    </div>

    <section class="stats-grid">
      <article class="stat-card">
        <p class="stat-label">TOTAL</p>
        <p class="stat-value">{{ stats.total }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #3b82f6;">AUJOURD'HUI</p>
        <p class="stat-value">{{ stats.today }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #8b5cf6;">CETTE SEMAINE</p>
        <p class="stat-value">{{ stats.week }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #10b981;">CE MOIS</p>
        <p class="stat-value">{{ stats.month }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #f59e0b;">CETTE ANNÉE</p>
        <p class="stat-value">{{ stats.year }}</p>
      </article>
    </section>

    <section class="card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Client</th>
              <th>Booking</th>
              <th class="text-center">Conteneurs</th>
              <th class="text-center">Volume (m³)</th>
              <th>Début</th>
              <th>Fin</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredEmpotages">
              <td>
                <div class="client-info">
                  <strong>{{ item.client }}</strong>
                </div>
              </td>
              <td>
                <a href="#" class="booking-link">{{ item.booking }}</a>
              </td>
              <td class="text-center">{{ item.conteneurs }}</td>
              <td class="text-center">{{ item.volume }}</td>
              <td>
                 <span style="font-size: 0.9rem; color: #64748b;">{{ item.dateStart | date:'dd/MM/yyyy HH:mm' }}</span>
              </td>
              <td>
                 <span style="font-size: 0.9rem; color: #64748b;">{{ item.dateEnd | date:'dd/MM/yyyy HH:mm' }}</span>
              </td>
              <td class="text-right">
                <div class="actions">
                  <button class="btn-icon" title="Modifier" (click)="editEmpotage(item)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="btn-icon delete-btn" title="Supprimer" (click)="deleteEmpotage(item)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
