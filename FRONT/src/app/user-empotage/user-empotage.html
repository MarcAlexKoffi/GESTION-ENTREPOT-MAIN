<div class="pageMain">
  <div class="page-shell">
    <header class="page-header">
      <div class="page-title-block">
        <h1 class="page-title">Gestion des Empotages</h1>
        <p class="page-subtitle">Suivez et gérez l'ensemble de vos opérations de chargement.</p>
      </div>
      <button class="btn-primary-main" (click)="openCreateModal()">
        <span class="material-symbols-outlined">add</span>
        <span>Nouveau empotage</span>
      </button>
    </header>

    <!-- CONTROLS: search, status filter, export -->
    <div class="controls-row">
      <div class="control-item">
        <input type="text" placeholder="Recherche client ou booking..." [(ngModel)]="search" (ngModelChange)="loadEmpotages()" class="search-input" />
      </div>
      <div class="control-item">
        <select [(ngModel)]="filterStatus" (change)="loadEmpotages()" class="status-select">
          <option value="">Tous les statuts</option>
          <option value="A venir">À venir</option>
          <option value="En cours">En cours</option>
          <option value="Terminé">Terminé</option>
        </select>
      </div>
      <div class="control-item control-actions">
        <button class="btn-primary-main" (click)="exportCsvServer()" [disabled]="loading">
          <span class="material-symbols-outlined">file_download</span>
          <span>Exporter CSV</span>
        </button>
      </div>
    </div>

    <!-- CREATE MODAL -->
    <div class="modal-backdrop" *ngIf="showCreateModal">
      <div class="modal-card">
        <h3>Créer un nouvel empotage</h3>
        <form (submit)="createEmpotage(); $event.preventDefault();">
          <div class="form-row">
            <label>Client</label>
            <input type="text" [(ngModel)]="newEmpotage.client" name="client" required />
          </div>

          <div class="form-row">
            <label>Type client</label>
            <input type="text" [(ngModel)]="newEmpotage.clientType" name="clientType" />
          </div>

          <div class="form-row">
            <label>Booking</label>
            <input type="text" [(ngModel)]="newEmpotage.booking" name="booking" required />
          </div>

          <div class="form-row two-cols">
            <div>
              <label>Conteneurs</label>
              <input type="number" min="1" [(ngModel)]="newEmpotage.conteneurs" name="conteneurs" />
            </div>
            <div>
              <label>Volume (m³)</label>
              <input type="number" step="0.1" [(ngModel)]="newEmpotage.volume" name="volume" />
            </div>
          </div>

          <div class="form-row two-cols">
            <div>
              <label>Début</label>
              <input type="datetime-local" [(ngModel)]="newEmpotage.dateStart" name="dateStart" />
            </div>
            <div>
              <label>Fin</label>
              <input type="datetime-local" [(ngModel)]="newEmpotage.dateEnd" name="dateEnd" />
            </div>
          </div>

          <div class="form-row">
            <label>Statut</label>
            <select [(ngModel)]="newEmpotage.status" name="status">
              <option value="A venir">A venir</option>
              <option value="En cours">En cours</option>
              <option value="Terminé">Terminé</option>
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeCreateModal()" [disabled]="saving">Annuler</button>
            <button type="submit" class="btn-primary-main" [disabled]="saving">
              <span *ngIf="!saving">Créer</span>
              <span *ngIf="saving">En cours...</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <section class="stats-grid">
      <article class="stat-card">
        <p class="stat-label">TOTAL</p>
        <p class="stat-value">{{ stats.total }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #3b82f6;">EN COURS</p>
        <p class="stat-value">{{ stats.enCours }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #10b981;">TERMINÉS</p>
        <p class="stat-value">{{ stats.termines }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #94a3b8;">À VENIR</p>
        <p class="stat-value">{{ stats.aVenir }}</p>
      </article>
    </section>

    <section class="card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Client</th>
              <th>Booking</th>
              <th class="text-center">Conteneurs</th>
              <th class="text-center">Volume (m³)</th>
              <th>Période</th>
              <th>Statut</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of empotages">
              <td>
                <div class="client-info">
                  <strong>{{ item.client }}</strong>
                  <small>{{ item.clientType }}</small>
                </div>
              </td>
              <td>
                <a href="#" class="booking-link">{{ item.booking }}</a>
              </td>
              <td class="text-center">{{ item.conteneurs }}</td>
              <td class="text-center">{{ item.volume }}</td>
              <td>{{ item.dateStart }} - {{ item.dateEnd }}</td>
              <td>
                <span class="status-pill" [ngClass]="getStatusClass(item.status)">
                  {{ item.status }}
                </span>
              </td>
              <td class="text-right">
                <div class="actions">
                  <button class="actions-menu-button" title="Modifier">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="actions-menu-button" title="Modifier" (click)="editEmpotage(item)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="actions-menu-button" title="Voir" (click)="viewEmpotage(item)">
                    <span class="material-symbols-outlined">visibility</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>
