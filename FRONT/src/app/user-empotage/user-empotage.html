<div class="pageMain">
  <div class="page-shell">
    <header class="page-header">
      <div class="page-title-block">
        <h1 class="page-title">Gestion des Empotages</h1>
        <p class="page-subtitle">Suivez et gérez l'ensemble de vos opérations de chargement.</p>
      </div>
      <button class="btn-primary-main" (click)="openCreateModal()">
        <span class="material-symbols-outlined">add</span>
        <span>Nouveau empotage</span>
      </button>
    </header>

    <!-- CONTROLS: search, status filter, export -->
    <div class="controls-row">
      <div class="control-item">
        <input type="text" placeholder="Recherche client ou booking..." [(ngModel)]="search" (ngModelChange)="calculateStats()" class="search-input" />
      </div>
      <div class="control-item">
        <input 
          type="date" 
          [(ngModel)]="filterDate" 
          (ngModelChange)="calculateStats()"
          class="status-select" 
          style="padding: 0.75rem; color: #64748b; font-family: inherit;" 
        />
      </div>
      <div class="control-item control-actions">
        <button class="btn-primary-main" (click)="exportCsvServer()" [disabled]="loading">
          <span class="material-symbols-outlined">file_download</span>
          <span>Exporter CSV</span>
        </button>
      </div>
    </div>

    <!-- CREATE MODAL -->
    <div class="modal-backdrop" *ngIf="showCreateModal">
      <div class="modal-card">
        <div class="modal-header">
          <h3>{{ isEditing ? 'Modifier empotage' : 'Créer un nouvel empotage' }}</h3>
          <button class="btn-close-modal" (click)="closeCreateModal()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <form (submit)="saveEmpotage(); $event.preventDefault();">
          <div class="form-row">
            <label>Client</label>
            <input type="text" [(ngModel)]="newEmpotage.client" name="client" required />
          </div>

          <div class="form-row">
            <label>Type client</label>
            <input type="text" [(ngModel)]="newEmpotage.clientType" name="clientType" />
          </div>

          <div class="form-row">
            <label>Booking</label>
            <input type="text" [(ngModel)]="newEmpotage.booking" name="booking" required />
          </div>

          <div class="form-row two-cols">
            <div>
              <label>Conteneurs</label>
              <input type="number" min="1" [(ngModel)]="newEmpotage.conteneurs" name="conteneurs" />
            </div>
            <div>
              <label>Volume (m³)</label>
              <input type="number" step="0.1" [(ngModel)]="newEmpotage.volume" name="volume" />
            </div>
          </div>

          <div class="form-row two-cols">
            <div>
              <label>Début</label>
              <input type="datetime-local" [(ngModel)]="newEmpotage.dateStart" name="dateStart" />
            </div>
            <div>
              <label>Fin</label>
              <input type="datetime-local" [(ngModel)]="newEmpotage.dateEnd" name="dateEnd" />
            </div>
          </div>

          <div class="form-row">
            <label>Statut</label>
            <select [(ngModel)]="newEmpotage.status" name="status">
              <option value="A venir">A venir</option>
              <option value="En cours">En cours</option>
              <option value="Terminé">Terminé</option>
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeCreateModal()" [disabled]="saving">Annuler</button>
            <button type="submit" class="btn-primary-main" [disabled]="saving">
              <span *ngIf="!saving">{{ isEditing ? 'Enregistrer' : 'Créer' }}</span>
              <span *ngIf="saving">En cours...</span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- DELETE CONFIRMATION MODAL -->
    <div class="modal-backdrop" *ngIf="showDeleteModal">
      <div class="modal-card" style="max-width: 400px;">
        <div class="modal-header">
          <h3>Confirmer la suppression</h3>
          <button class="btn-close-modal" (click)="cancelDelete()">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div style="margin-bottom: 2rem; color: var(--text-secondary); line-height: 1.5;">
          <p>Êtes-vous sûr de vouloir supprimer cet empotage ?</p>
          <p *ngIf="itemToDelete" style="font-weight: 600; color: var(--text-primary); margin-top: 0.5rem;">
            {{ itemToDelete.client }} ({{ itemToDelete.booking }})
          </p>
          <p style="margin-top: 0.5rem; font-size: 0.9em;">Cette action est irréversible.</p>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" (click)="cancelDelete()">Annuler</button>
          <button type="button" class="btn-primary-main" style="background: #ef4444; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);" (click)="confirmDelete()">
            Supprimer
          </button>
        </div>
      </div>
    </div>

    <section class="stats-grid">
      <article class="stat-card">
        <p class="stat-label">TOTAL</p>
        <p class="stat-value">{{ stats.total }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #3b82f6;">AUJOURD'HUI</p>
        <p class="stat-value">{{ stats.today }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #8b5cf6;">CETTE SEMAINE</p>
        <p class="stat-value">{{ stats.week }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #10b981;">CE MOIS</p>
        <p class="stat-value">{{ stats.month }}</p>
      </article>
      <article class="stat-card">
        <p class="stat-label" style="color: #f59e0b;">CETTE ANNÉE</p>
        <p class="stat-value">{{ stats.year }}</p>
      </article>
    </section>

    <section class="card">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Client</th>
              <th>Booking</th>
              <th class="text-center">Conteneurs</th>
              <th class="text-center">Volume (m³)</th>
              <th>Début</th>
              <th>Fin</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of filteredEmpotages">
              <td>
                <div class="client-info">
                  <strong>{{ item.client }}</strong>
                  <small>{{ item.clientType }}</small>
                </div>
              </td>
              <td>
                <a href="#" class="booking-link">{{ item.booking }}</a>
              </td>
              <td class="text-center">{{ item.conteneurs }}</td>
              <td class="text-center">{{ item.volume }}</td>
              <td>
                 <span style="font-size: 0.9rem; color: #64748b;">{{ item.dateStart | date:'dd/MM/yyyy HH:mm' }}</span>
              </td>
              <td>
                 <span style="font-size: 0.9rem; color: #64748b;">{{ item.dateEnd | date:'dd/MM/yyyy HH:mm' }}</span>
              </td>
              <td class="text-right">
                <div class="actions">
                  <button class="actions-menu-button" title="Modifier" (click)="editEmpotage(item)">
                    <span class="material-symbols-outlined">edit</span>
                  </button>
                  <button class="actions-menu-button delete-btn" title="Supprimer" (click)="deleteEmpotage(item)">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>
