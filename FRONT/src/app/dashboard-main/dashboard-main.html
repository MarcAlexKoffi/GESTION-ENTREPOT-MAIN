<div class="pageMain">
  <div class="page-root">
    <main class="page-main">
      <div class="admin-scroll">
        <div class="content">
          <!-- HEADER -->
          <div class="page-head">
            <div>
              <h2 class="page-title">Vue d'ensemble des entrepôts</h2>
              <p class="page-desc">Bonjour, Marc. Bienvenue sur votre tableau de bord.</p>
            </div>

            <button class="btn btn-primary" type="button" (click)="openWarehouseModal()">
              <span class="material-symbols-outlined notranslate">add</span>
              <span>Nouvel Entrepôt</span>
            </button>
          </div>

          <!-- FILTERS (MATCHING SCREENSHOT) -->
          <!-- <section class="filters-chips-section" aria-label="Filtres">
            <div class="filter-chip-wrap">
              <span class="material-symbols-outlined notranslate chip-icon">location_on</span>
              <select aria-label="Filtrer par région">
                <option value="">Toutes les régions</option>
                <option value="nord">Nord</option>
                <option value="sud">Sud</option>
              </select>
              <span class="material-symbols-outlined notranslate chip-arrow">expand_more</span>
            </div>

            <div class="filter-chip-wrap">
              <span class="material-symbols-outlined notranslate chip-icon">factory</span>
              <select aria-label="Filtrer par site">
                <option value="">Tous les sites</option>
              </select>
              <span class="material-symbols-outlined notranslate chip-arrow">expand_more</span>
            </div>
          </section> -->

          <!-- Warehouses Grid (MATCHING SCREENSHOT) -->
          <div class="warehouse-grid">
            <article
              *ngFor="let card of cards"
              class="warehouse-card card"
              (click)="handleContainerClick(card)"
            >
              <!-- Image Section -->
              <div
                class="warehouse-image"
                [style.background-image]="'url(' + card.imageUrl + ')'"
              >
                <!-- Badge Notification Top Left -->
                <div *ngIf="card.unreadCount > 0" class="notification-badge">
                  {{ card.unreadCount }}
                </div>

                <!-- Menu Button Top Right -->
                <button
                  class="card-menu-btn"
                  type="button"
                  (click)="openActionsMenu(card, $event)"
                  title="Actions"
                >
                  <span class="material-symbols-outlined notranslate">more_vert</span>
                </button>

                <!-- Dropdown Menu -->
                <div
                  class="warehouse-dropdown"
                  *ngIf="actionsMenuWarehouseId === card.id"
                  (click)="$event.stopPropagation()"
                >
                  <button type="button" (click)="onEditWarehouse(card)">
                    <span class="material-symbols-outlined notranslate">edit</span>
                    Modifier
                  </button>
                  <button type="button" class="danger" (click)="onDeleteWarehouse(card)">
                    <span class="material-symbols-outlined notranslate">delete</span>
                    Supprimer
                  </button>
                </div>
              </div>

              <!-- Content Section -->
              <div class="warehouse-content">
                <div class="warehouse-info">
                  <h3 class="warehouse-name">{{ card.name }}</h3>
                  <p class="warehouse-location">
                    <span class="material-symbols-outlined notranslate">location_on</span>
                    {{ card.location }}
                  </p>
                </div>

                <div class="card-divider"></div>

                <div class="warehouse-footer">
                  <div class="status-block">
                    <span class="status-label">EN ATTENTE</span>
                    <span class="status-count">{{ card.pending }}</span>
                  </div>
                  <span class="material-symbols-outlined notranslate footer-arrow">arrow_forward</span>
                </div>
              </div>
            </article>
          </div>

          <!-- Chart Section -->
          <section class="card chart-section">
            <div class="section-head">
              <h3 class="chart-title">Volume de camions sur les 7 derniers jours</h3>
              <div class="chart-legend">
                <div class="legend-item"><span class="dot primary"></span> Camions enregistrés</div>
              </div>
            </div>

            <div class="chart-container">
              <!-- Background Grid Lines -->
              <div class="chart-grid-lines">
                <div class="grid-line"></div>
                <div class="grid-line"></div>
                <div class="grid-line"></div>
                <div class="grid-line"></div>
              </div>

              <div class="chart-bars">
                <div class="chart-day" *ngFor="let stat of stats">
                  <div class="chart-bar" [style.height]="stat.height">
                    <div class="bar-tooltip">{{ stat.count }}</div>
                  </div>
                  <p>{{ stat.day }}</p>
                </div>
              </div>
            </div>
          </section>

          <!-- MODALE : Créer/Modifier un entrepôt -->
          <div class="modal" *ngIf="showWarehouseModal">
            <div class="modal__backdrop" (click)="closeWarehouseModal()"></div>

            <div class="modal__panel">
              <div class="truck-modal-header">
                <h2 class="truck-modal-title">
                  {{ editingWarehouseId ? 'Modifier l’entrepôt' : 'Nouvel entrepôt' }}
                </h2>
                <button
                  type="button"
                  class="truck-modal-close"
                  aria-label="Fermer"
                  (click)="closeWarehouseModal()"
                >
                  <span class="material-symbols-outlined notranslate">close</span>
                </button>
              </div>

              <div class="truck-modal-body">
                <p class="modal-intro">
                  {{
                    editingWarehouseId
                      ? 'Modifiez les informations de l’entrepôt sélectionné.'
                      : 'Renseignez les informations ci-dessous pour créer un nouvel entrepôt.'
                  }}
                </p>

                <div class="truck-field">
                  <label class="truck-label">Nom de l’entrepôt</label>
                  <input
                    type="text"
                    class="truck-input"
                    placeholder="Ex : Entrepôt d'Abidjan"
                    [(ngModel)]="newWarehouse.name"
                  />
                </div>

                <div class="truck-field">
                  <label class="truck-label">Localisation</label>
                  <input
                    type="text"
                    class="truck-input"
                    placeholder="Ex : Abidjan, Côte d'Ivoire"
                    [(ngModel)]="newWarehouse.location"
                  />
                </div>

                <div class="truck-field">
                  <label class="truck-label">Image de couverture</label>

                  <div class="file-upload-container">
                    <!-- Hidden native input -->
                    <input
                      #fileInput
                      type="file"
                      accept="image/*"
                      style="display: none"
                      (change)="onImageSelected($event)"
                    />

                    <!-- Premium Custom Trigger -->
                    <div class="upload-controls">
                      <button type="button" class="file-upload-btn" (click)="fileInput.click()">
                        <span class="material-symbols-outlined notranslate">cloud_upload</span>
                        {{ selectedImageFile ? "Changer l'image" : 'Choisir une image' }}
                      </button>

                      <span class="file-name" [class.has-file]="!!selectedImageFile">
                        {{ selectedImageFile ? selectedImageFile.name : 'Aucun fichier choisi' }}
                      </span>
                    </div>
                  </div>
                  <p class="truck-help">Formats acceptés : JPG, PNG.</p>

                  <div
                    *ngIf="imagePreview"
                    class="image-preview-box"
                    [style.backgroundImage]="'url(' + imagePreview + ')'"
                  ></div>
                </div>
              </div>

              <div class="truck-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeWarehouseModal()">
                  Annuler
                </button>

                <button class="btn btn-primary" (click)="saveWarehouse()" [disabled]="isLoading">
                  <span *ngIf="isLoading">Enregistrement...</span>
                  <span *ngIf="!isLoading">
                    {{ editingWarehouseId ? 'Enregistrer' : 'Créer l’entrepôt' }}
                  </span>
                </button>
              </div>
            </div>
          </div>

          <!-- MODALE : Confirmation Suppression -->
          <div class="modal" *ngIf="showDeleteModal">
            <div class="modal__backdrop" (click)="closeDeleteModal()"></div>
            <div class="modal__panel" style="max-width: 420px;">
              <div class="truck-modal-header">
                <h2 class="truck-modal-title">Confirmer la suppression</h2>
                <button
                  type="button"
                  class="truck-modal-close"
                  aria-label="Fermer"
                  (click)="closeDeleteModal()"
                >
                  <span class="material-symbols-outlined notranslate">close</span>
                </button>
              </div>

              <div class="truck-modal-body">
                 <p style="color: #64748b; line-height: 1.5; margin-bottom: 0.5rem;">
                   Êtes-vous sûr de vouloir supprimer cet entrepôt ?
                 </p>
                 <div *ngIf="warehouseToDelete" style="background: #f8fafc; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0;">
                    <p style="margin: 0; font-weight: 700; color: #0f172a;">{{ warehouseToDelete.name }}</p>
                    <p style="margin: 0.25rem 0 0; font-size: 0.85rem; color: #64748b;">
                       {{ warehouseToDelete.location }}
                    </p>
                 </div>
                 <p style="color: #ef4444; font-size: 0.85rem; margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span class="material-symbols-outlined notranslate" style="font-size: 18px;">warning</span>
                    Cette action est irréversible.
                 </p>
              </div>

              <div class="truck-modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
                  Annuler
                </button>
                <button 
                  type="button" 
                  class="btn btn-primary" 
                  style="background: #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); border: none;"
                  (click)="confirmDelete()"
                >
                  Supprimer
                </button>
              </div>
            </div>
          </div>

          <!-- END MODAL -->
        </div>
      </div>
    </main>
  </div>
</div>
